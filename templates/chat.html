{% extends "base.html" %}
{% block content %}

<h1>Chat avec Betty</h1>

<div class="demo-frame" style="margin-top:20px">
  <div class="chat-frame" id="chat" style="display:flex;flex-direction:column;">
    <div style="padding:18px 16px 10px;border-bottom:1px solid var(--border);text-align:center">
      <img id="bot-avatar" src="" alt="Avatar"
           style="width:72px;height:72px;border-radius:999px;border:1px solid var(--border);background:#0b0f14;object-fit:cover;display:block;margin:0 auto 8px">
      <div id="bot-name" style="font-weight:700">Betty</div>
    </div>

    <div id="messages" style="padding:16px;overflow:auto;flex:1;scroll-behavior:smooth">
      <div id="greet" class="bubble"
           style="max-width:280px;background:#111827;border:1px solid var(--border);border-radius:12px;padding:12px;margin:8px 0">
        Bonjour, je suis Betty. Comment puis-je vous aider ?
      </div>
    </div>

    <form id="form" style="padding:14px;border-top:1px solid var(--border);display:flex;gap:8px">
      <input id="input" type="text" placeholder="Écrivez et appuyez sur Entrée…" autocomplete="off" autofocus
             style="background:#0b0f14;border:1px solid var(--border);border-radius:10px;color:var(--text);padding:12px;flex:1">
      <button class="btn" type="submit">Envoyer</button>
    </form>
  </div>
</div>

<script>
  const botId = new URLSearchParams(location.search).get('bot_id') || 'avocat-001';

  const avatarEl = document.getElementById('bot-avatar');
  const nameEl   = document.getElementById('bot-name');
  const greetEl  = document.getElementById('greet');
  const msgs     = document.getElementById('messages');
  const form     = document.getElementById('form');
  const input    = document.getElementById('input');

  // Focus intelligent : taper n'importe où = focus sur l'input
  document.addEventListener('keydown', (e) => {
    const ign = ['Enter','Escape','Tab'];
    if (ign.includes(e.key)) return;
    if (document.activeElement !== input) {
      input.focus();
      if (e.key.length === 1 && !e.ctrlKey && !e.metaKey && !e.altKey) {
        e.preventDefault();
        input.value += e.key;
      }
    }
  });

  function scrollToBottom(){ msgs.scrollTop = msgs.scrollHeight; }

  // Meta bot
  fetch(`/api/bot_meta?bot_id=${encodeURIComponent(botId)}`)
    .then(r => r.json())
    .then(meta => {
      nameEl.textContent = meta.name || 'Betty';
      avatarEl.src = meta.avatar_url || '';
      if (meta.greeting) greetEl.textContent = meta.greeting;
      document.documentElement.style.setProperty('--primary', meta.color_hex || '#4F46E5');
      scrollToBottom();
    }).catch(()=>{});

  // Bulle
  function addBubble(text, mine=false){
    const div = document.createElement('div');
    div.className = 'bubble';
    div.style.maxWidth = '280px';
    div.style.border = '1px solid var(--border)';
    div.style.borderRadius = '12px';
    div.style.padding = '12px';
    div.style.margin = '8px 0';
    div.style.whiteSpace = 'pre-wrap';
    div.textContent = text;
    if(mine){ div.style.background='#1b2230'; div.style.marginLeft='auto'; }
    else    { div.style.background='#111827'; div.style.marginRight='auto'; }
    msgs.appendChild(div);
    scrollToBottom();
    return div;
  }

  // Loader "Betty écrit…"
  function showTyping(){
    const t = document.createElement('div');
    t.className = 'bubble typing';
    t.style.maxWidth = '280px';
    t.style.border = '1px solid var(--border)';
    t.style.borderRadius = '12px';
    t.style.padding = '12px';
    t.style.margin = '8px 0';
    t.style.background = '#111827';
    t.style.marginRight = 'auto';
    t.innerHTML = '<span class="label">Betty écrit</span><span class="dots"><i></i><i></i><i></i></span>';
    msgs.appendChild(t);
    scrollToBottom();
    return t;
  }
  function hideTyping(el){ if(el && el.parentNode) el.parentNode.removeChild(el); }

  // Submit
  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const text = input.value.trim();
    if(!text) return;
    addBubble(text, true);
    input.value = '';

    const typing = showTyping();
    try {
      const r = await fetch('/api/bettybot', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ message: text, bot_id: botId })
      });
      const j = await r.json();
      hideTyping(typing);
      addBubble(j.response || "Désolé, une erreur est survenue.");
    } catch {
      hideTyping(typing);
      addBubble("Désolé, une erreur est survenue.");
    }
  });

  window.addEventListener('load', ()=>{ input.focus(); scrollToBottom(); });
</script>

{% endblock %}
