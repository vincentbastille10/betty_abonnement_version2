<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>{{ full_name or "Betty Bot" }}</title>
  <style>
    :root{
      --bg:#0b0f1e;
      --line:#1e2640;
      --ink:#f5f7ff;
      --muted:#a9b1c6;
      --brand:{{ color }};
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      background:var(--bg);
      color:var(--ink);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
      display:flex;
      flex-direction:column;
      height:100vh;
    }
    header{
      display:flex; align-items:center; gap:12px;
      padding:10px 14px; border-bottom:1px solid var(--line); background:#0d1220;
    }
    header.compact{ padding:6px 12px; }
    .avatar{ width:40px; height:40px; border-radius:10px; overflow:hidden; border:1px solid var(--line); background:#0c0f16; flex-shrink:0; }
    .avatar img{ width:100%; height:100%; object-fit:cover; }
    h1{ font-size:15px; font-weight:600; line-height:1.2; margin:0; }
    .sub{ font-size:12px; color:var(--muted); }

    .chat-box{ flex:1; overflow-y:auto; padding:14px; scroll-behavior:smooth; }
    .msg{ max-width:80%; margin:8px 0; padding:10px 14px; border-radius:12px; line-height:1.4; word-wrap:break-word; white-space:pre-wrap; }
    .user{ background:#1a2140; color:#fff; margin-left:auto; }
    .bot{ background:#141a2f; color:var(--ink); }

    form{ display:flex; padding:10px; border-top:1px solid var(--line); background:#0d1220; }
    input[type=text]{ flex:1; background:#0a0f20; border:1px solid var(--line); border-radius:10px; color:var(--ink); font-size:14px; padding:10px 12px; }
    button{ background:var(--brand); border:0; border-radius:10px; color:#fff; padding:10px 16px; font-weight:600; margin-left:8px; cursor:pointer; }
  </style>
</head>
<body>

  <header class="{{ 'compact' if embed else '' }}">
    <div class="avatar">
      <img src="{{ avatar_url }}" alt="avatar"
           onerror="this.onerror=null;this.src='/avatar/immo'">
    </div>
    <div>
      <h1>{{ full_name or "Betty Bot" }}</h1>
      <div class="sub">{{ header_title or "Votre assistante AI" }}</div>
    </div>
  </header>

  <div class="chat-box" id="chat-box">
    <div class="msg bot">{{ greeting }}</div>
  </div>

  <form id="chat-form" autocomplete="off">
    <input type="text" id="message" name="message" placeholder="Écrivez votre message..." />
    <button type="submit">Envoyer</button>
  </form>

  <script>
    const form = document.getElementById("chat-form");
    const box = document.getElementById("chat-box");
    const input = document.getElementById("message");

    const BOT_ID = "{{ public_id }}";
    const BUYER_EMAIL = "{{ buyer_email }}";
    let convId = "conv_" + BOT_ID;

    function appendMsg(cls, txt) {
      const d = document.createElement("div");
      d.className = "msg " + cls;
      d.textContent = txt;
      box.appendChild(d);
      box.scrollTop = box.scrollHeight;
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const msg = input.value.trim();
      if (!msg) return;
      appendMsg("user", msg);
      input.value = "";
      try {
        const res = await fetch("/api/bettybot", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            message: msg,
            public_id: BOT_ID,
            conv_id: convId,
            buyer_email: BUYER_EMAIL
          })
        });
        const data = await res.json();
        if (data.response) {
          // retire le tag <LEAD_JSON>...</LEAD_JSON> éventuel à la fin de la réponse
          const cleaned = String(data.response).replace(/<LEAD_JSON>[\s\S]*<\/LEAD_JSON>\s*$/,'').trim();
          appendMsg("bot", cleaned || ""); 
        }

      } catch (err) {
        appendMsg("bot", "⚠️ Erreur de connexion, veuillez réessayer.");
      }
    });
  </script>
</body>
</html>
