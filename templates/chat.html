{% extends "base.html" %}
{% block content %}
<h1>✨ Betty Bots</h1>

<div class="demo-frame">
  <div class="chat-frame" id="chat">
    <div style="padding:16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px">
      <img id="bot-avatar" src="" alt="Avatar" style="width:36px;height:36px;border-radius:999px;border:1px solid var(--border);background:#0b0f14;object-fit:cover">
      <div>
        <div id="bot-name" style="font-weight:700">Betty</div>
        <div id="bot-pack" style="font-size:12px;color:var(--muted)"></div>
      </div>
    </div>

    <div id="messages" style="padding:16px;overflow:auto;height:390px">
      <div id="greet" class="bubble" style="max-width:280px;background:#111827;border:1px solid var(--border);border-radius:12px;padding:12px;margin-bottom:10px">
        Bonjour, je suis Betty. Comment puis-je vous aider ?
      </div>
    </div>

    <form id="form" style="padding:16px;border-top:1px solid var(--border)">
      <input id="input" type="text" placeholder="Écrivez et appuyez sur Entrée…" autocomplete="off">
      <button class="btn" style="margin-left:8px" type="submit">Envoyer</button>
    </form>
  </div>
</div>

<script>
  const qs = new URLSearchParams(location.search);
  const botId = qs.get('bot_id') || 'avocat-001';

  // UI refs
  const avatarEl = document.getElementById('bot-avatar');
  const nameEl   = document.getElementById('bot-name');
  const packEl   = document.getElementById('bot-pack');
  const greetEl  = document.getElementById('greet');
  const msgs     = document.getElementById('messages');
  const form     = document.getElementById('form');
  const input    = document.getElementById('input');

  // Charge meta (nom, avatar, couleur, greeting, etc.)
  fetch(`/api/bot_meta?bot_id=${encodeURIComponent(botId)}`)
    .then(r => r.json())
    .then(meta => {
      nameEl.textContent = meta.name || 'Betty';
      packEl.textContent = `ID: ${botId}`;
      avatarEl.src = meta.avatar_url || '';
      if (meta.greeting) greetEl.textContent = meta.greeting;
      // Couleur d’accent
      document.documentElement.style.setProperty('--primary', meta.color_hex || '#4F46E5');
    })
    .catch(() => { /* silencieux */ });

  function addBubble(text, mine=false){
    const div = document.createElement('div');
    div.className = 'bubble';
    div.style.maxWidth = '280px';
    div.style.border = '1px solid var(--border)';
    div.style.borderRadius = '12px';
    div.style.padding = '12px';
    div.style.margin = '8px 0';
    div.style.whiteSpace = 'pre-wrap';
    div.textContent = text;
    if(mine){
      div.style.background = '#1b2230';
      div.style.marginLeft = 'auto';
    } else {
      div.style.background = '#111827';
      div.style.marginRight = 'auto';
    }
    msgs.appendChild(div);
    msgs.scrollTop = msgs.scrollHeight;
  }

  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const text = input.value.trim();
    if(!text) return;
    addBubble(text, true);
    input.value = '';

    try {
      const r = await fetch('/api/bettybot', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ message: text, bot_id: botId })
      });
      const j = await r.json();
      addBubble(j.response || "Désolé, une erreur est survenue.");
    } catch {
      addBubble("Désolé, une erreur est survenue.");
    }
  });
</script>

<style>
  .chat-frame input{
    background:#0b0f14;border:1px solid var(--border);border-radius:10px;color:var(--text);padding:10px;width:calc(100% - 96px)
  }
</style>
{% endblock %}
