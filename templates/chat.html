@app.route("/chat")
def chat_page():
    """
    Page du chat Betty Bot (intégrable via iframe)
    Exemple : /chat?public_id=immo-002-5230563d&embed=1&buyer_email=contact@client.com
    """

    # --- PARAMÈTRES URL ---
    public_id   = (request.args.get("public_id") or "").strip()
    embed       = request.args.get("embed", "0") == "1"
    buyer_email = (request.args.get("buyer_email") or "").strip()

    # --- RÉCUPÉRATION DU BOT ---
    # Si le bot existe déjà dans la DB, on le charge.
    bot = db_get_bot(public_id)

    # Si aucun bot trouvé, on crée une instance par défaut (fallback).
    if not bot:
        base = BOTS["avocat-001"]
        bot = {
            "public_id": public_id or "avocat-001-demo",
            "name": base["name"],
            "color": base["color"],
            "avatar_file": base["avatar_file"],
            "greeting": "Bonjour, je suis Betty. Comment puis-je vous aider ?",
            "owner_name": "Client",
            "profile": {},
            "pack": base["pack"],
            "buyer_email": buyer_email  # on conserve l’email si fourni dans l’URL
        }

    # --- INFOS D’AFFICHAGE ---
    display_name = bot.get("name") or "Betty Bot"

    pack_code = (bot.get("pack") or "").lower()
    pack_label_map = {
        "medecin": "Médecin",
        "avocat": "Avocat",
        "immo": "Immobilier",
        "immobilier": "Immobilier",
        "notaire": "Notaire",
    }
    pack_label = pack_label_map.get(pack_code, "")

    if pack_label:
        full_name = f"{display_name} ({pack_label})"
    else:
        full_name = display_name

    # --- AVATAR ET COULEUR ---
    avatar_file = bot.get("avatar_file") or "avocat.jpg"
    color_hex   = bot.get("color") or "#4F46E5"

    # --- MESSAGE D’ACCUEIL ---
    greeting_text = (
        bot.get("greeting")
        or "Bonjour, je suis Betty. Comment puis-je vous aider ?"
    )

    # --- PROPAGATION DU BUYER EMAIL ---
    # On essaie plusieurs sources : DB > URL > fallback
    buyer_email_final = (
        buyer_email
        or bot.get("buyer_email")
        or os.getenv("DEFAULT_LEAD_EMAIL", "")
    )

    # --- LOGS DEBUG ---
    app.logger.info(
        f"[CHAT] public_id={public_id} embed={embed} buyer_email={buyer_email_final}"
    )

    # --- RENDU DU TEMPLATE ---
    try:
        return render_template(
            "chat.html",
            title="Betty — Chat",
            base_url=BASE_URL,
            public_id=bot.get("public_id") or "",
            full_name=full_name,
            header_title="Betty Bot, votre assistante AI",
            color=color_hex,
            avatar_url=static_url(avatar_file),
            greeting=greeting_text,
            embed=embed,
            buyer_email=buyer_email_final
        )
    except Exception as e:
        # Si le template crash, on affiche une erreur lisible
        app.logger.exception(f"[CHAT] Erreur rendu template : {e}")
        return (
            f"<h3 style='color:red;text-align:center;'>Erreur de rendu du chat : {e}</h3>",
            500,
        )
