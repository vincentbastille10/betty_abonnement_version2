{% extends "base.html" %}
{% block content %}

<h1>Configurer votre chatbot</h1>
<p class="intro">Choisissez un m√©tier, une couleur, ajustez la personnalit√© et personnalisez le message d‚Äôaccueil.</p>

<form method="POST" action="{{ url_for('config_page') }}" id="cfg-form" class="cfg-grid">

  <!-- M√©tier / Avatar -->
  <section class="card">
    <h2>M√©tier</h2>
    <div class="avatar-grid">

      <!-- Avocat -->
      <label class="avatar-card selected">
        <input type="radio" name="pack" value="avocat" data-avatar="avocat.jpg" checked>
        <img src="{{ url_for('static', filename='avocat.jpg') }}" alt="Avocat">
        <div class="a-label">Avocat</div>
      </label>

      <!-- M√©decin -->
      <label class="avatar-card">
        <input type="radio" name="pack" value="medecin" data-avatar="medecin.jpg">
        <img src="{{ url_for('static', filename='medecin.jpg') }}" alt="M√©decin">
        <div class="a-label">M√©decin</div>
      </label>

      <!-- Immobilier -->
      <label class="avatar-card">
        <input type="radio" name="pack" value="immo" data-avatar="immo.jpg">
        <img src="{{ url_for('static', filename='immo.jpg') }}" alt="Immobilier">
        <div class="a-label">Immobilier</div>
      </label>

    </div>
    <small class="hint">Cliquez pour s√©lectionner. Taille d‚Äôaffichage : 4 cm √ó 4 cm.</small>

    <!-- üîí Un SEUL avatar envoy√© au back -->
    <input type="hidden" name="avatar" id="avatar-hidden" value="avocat.jpg">

    <!-- ===== TIROIR METIER ===== -->
    <div class="metier-drawer">
      <button type="button" class="drawer-toggle" id="drawer-toggle">
        Plus de m√©tiers : faites d√©rouler le menu
      </button>

      <div class="drawer-panel" id="drawer-panel" hidden>
        <!-- radio cach√© qui portera le pack choisi dans le tiroir -->
        <input type="radio" name="pack" id="drawer-pack-radio" value="" data-avatar="" style="display:none">

        <p class="hint">Cliquez sur votre m√©tier pour charger l‚Äôavatar et le pack correspondant.</p>
        <ul class="drawer-list">
          <!-- Liste alphab√©tique des packs betty_... -->
          <li class="drawer-item" data-pack="betty_aide_a_dom"            data-avatar="Betty_aide_a_dom.png">betty_aide_a_dom</li>
          <li class="drawer-item" data-pack="betty_aide_a_domicile"      data-avatar="Betty_aide_a_domicile.png">betty_aide_a_domicile</li>
          <li class="drawer-item" data-pack="betty_architecte"           data-avatar="Betty_architecte.png">betty_architecte</li>
          <li class="drawer-item" data-pack="betty_artisan"              data-avatar="Betty_artisan.png">betty_artisan</li>
          <li class="drawer-item" data-pack="betty_assistance_scolaire"  data-avatar="Betty_assistance_scolaire.png">betty_assistance_scolaire</li>
          <li class="drawer-item" data-pack="betty_assurance"            data-avatar="Betty_assurance.png">betty_assurance</li>
          <li class="drawer-item" data-pack="betty_coach"                data-avatar="Betty_coach.png">betty_coach</li>
          <li class="drawer-item" data-pack="betty_coiffeur"             data-avatar="Betty_coiffeur.png">betty_coiffeur</li>
          <li class="drawer-item" data-pack="betty_dentiste"             data-avatar="Betty_dentiste.png">betty_dentiste</li>
          <li class="drawer-item" data-pack="betty_dj"                   data-avatar="Betty_DJ.png">betty_dj</li>
          <li class="drawer-item" data-pack="betty_estheticienne"        data-avatar="Betty_estheticienne.png">betty_estheticienne</li>
          <li class="drawer-item" data-pack="betty_garde_denfant"        data-avatar="Betty_garde_denfant.png">betty_garde_denfant</li>
          <li class="drawer-item" data-pack="betty_graphiste"            data-avatar="Betty_graphiste.png">betty_graphiste</li>
          <li class="drawer-item" data-pack="betty_infirmiere"           data-avatar="Betty_infirmiere.png">betty_infirmiere</li>
          <li class="drawer-item" data-pack="betty_kine"                 data-avatar="Betty_kine.png">betty_kine</li>
          <li class="drawer-item" data-pack="betty_marketing"            data-avatar="Betty_marketing.png">betty_marketing</li>
          <li class="drawer-item" data-pack="betty_mecano"               data-avatar="Betty_mecano.png">betty_mecano</li>
          <li class="drawer-item" data-pack="betty_menage"               data-avatar="Betty_menage.png">betty_menage</li>
          <li class="drawer-item" data-pack="betty_nutritioniste"        data-avatar="Betty_nutritioniste.png">betty_nutritioniste</li>
          <li class="drawer-item" data-pack="betty_osteopate"            data-avatar="Betty_osteopate.png">betty_osteopate</li>
          <li class="drawer-item" data-pack="betty_paysagiste"           data-avatar="Betty_paysagiste.png">betty_paysagiste</li>
          <li class="drawer-item" data-pack="betty_photographe"          data-avatar="Betty_photographe.png">betty_photographe</li>
          <li class="drawer-item" data-pack="betty_plombier"             data-avatar="Betty_plombier.png">betty_plombier</li>
          <li class="drawer-item" data-pack="betty_serrurier"            data-avatar="Betty_serrurier.png">betty_serrurier</li>
          <li class="drawer-item" data-pack="betty_sophrologue"          data-avatar="Betty_sophrologue.png">betty_sophrologue</li>
          <li class="drawer-item" data-pack="betty_soutien_scolaire"     data-avatar="Betty_soutien_scolaire.png">betty_soutien_scolaire</li>
          <li class="drawer-item" data-pack="betty_trader"               data-avatar="Betty_trader.png">betty_trader</li>
          <li class="drawer-item" data-pack="betty_traiteur"             data-avatar="Betty_traiteur.png">betty_traiteur</li>
          <li class="drawer-item" data-pack="betty_verrier"              data-avatar="Betty_verrier.png">betty_verrier</li>
          <li class="drawer-item" data-pack="betty_yoga"                 data-avatar="Betty_yoga.png">betty_yoga</li>
        </ul>
      </div>
    </div>
    <!-- ===== /TIROIR METIER ===== -->

  </section>

  <!-- Couleurs -->
  <section class="card">
    <h2>Couleur</h2>
    <div class="color-grid">
      <label class="color-swatch" style="--c:#4F46E5">
        <input type="radio" name="color" value="#4F46E5" checked>
      </label>
      <label class="color-swatch" style="--c:#16A34A">
        <input type="radio" name="color" value="#16A34A">
      </label>
      <label class="color-swatch" style="--c:#0284C7">
        <input type="radio" name="color" value="#0284C7">
      </label>
      <label class="color-swatch" style="--c:#DB2777">
        <input type="radio" name="color" value="#DB2777">
      </label>
      <label class="color-swatch" style="--c:#F59E0B">
        <input type="radio" name="color" value="#F59E0B">
      </label>
      <label class="color-swatch" style="--c:#10B981">
        <input type="radio" name="color" value="#10B981">
      </label>
    </div>
  </section>

  <!-- Personnalit√© (curseur 2D) -->
  <section class="card">
    <h2>Personnalit√©</h2>
    <div class="axes-wrap">
      <div class="axis-label top">Chaleureuse</div>
      <div class="axis-label left">Empathique</div>
      <div class="joystick" id="joy">
        <div class="thumb" id="thumb"></div>
      </div>
      <div class="axis-label right">Efficace</div>
      <div class="axis-label bottom">Pr√©cise</div>
    </div>
    <input type="hidden" name="persona_x" id="persona_x" value="0">
    <input type="hidden" name="persona_y" id="persona_y" value="0">
    <small class="hint">D√©placez le curseur : gauche = empathique, droite = efficace, haut = chaleureuse, bas = pr√©cise.</small>
  </section>

  <!-- Contenus -->
  <section class="card">
    <h2>Contenus</h2>
    <label class="field">
      <span>Message d‚Äôaccueil</span>
      <input type="text" name="greeting" placeholder="Bonjour, je suis Betty. Comment puis-je vous aider ?">
    </label>

    <label class="field">
      <span>Informations √©tablissement (t√©l√©phone, email, adresse, horaires‚Ä¶)</span>
      <textarea name="contact_info" rows="4" placeholder="Nom : Cabinet Dupont
T√©l√©phone : 02 43 XX XX XX
Email : contact@cabinet-dupont.fr
Adresse : 12 rue de la R√©publique, 72000 Le Mans
Horaires : Lun‚ÄìVen 9h‚Äì12h / 14h‚Äì18h"></textarea>
    </label>
  </section>

  <!-- CTA -->
  <div class="cta">
    <button type="submit" class="btn primary big">Enregistrer et s‚Äôabonner</button>
  </div>
</form>

<script>
  // ====== Pack <-> Avatar : synchro 100% fiable ======
  const packRadios   = document.querySelectorAll('input[type="radio"][name="pack"]');
  const avatarHidden = document.getElementById('avatar-hidden');
  const cards        = document.querySelectorAll('.avatar-card');

  function applySelection(radio){
    // 1) avatar (valeur envoy√©e au backend)
    const file = radio.getAttribute('data-avatar') || 'avocat.jpg';
    avatarHidden.value = file;

    // 2) carte active (surbrillance)
    cards.forEach(c => c.classList.remove('selected'));
    const card = radio.closest('.avatar-card');
    if(card) card.classList.add('selected');
  }

  // Initialisation (au cas o√π le serveur pr√©renseigne un pack)
  document.addEventListener('DOMContentLoaded', () => {
    const checked = document.querySelector('input[name="pack"]:checked');
    if (checked) applySelection(checked);
  });

  // Changement de pack (avatars principaux)
  packRadios.forEach(r => {
    r.addEventListener('change', () => applySelection(r));
    const card = r.closest('.avatar-card');
    if(card){
      card.addEventListener('click', () => {
        r.checked = true;
        applySelection(r);
      });
    }
  });

  // ====== TIROIR METIER ======
  const drawerToggle   = document.getElementById('drawer-toggle');
  const drawerPanel    = document.getElementById('drawer-panel');
  const drawerRadio    = document.getElementById('drawer-pack-radio');
  const drawerItems    = document.querySelectorAll('.drawer-item');

  if (drawerToggle && drawerPanel) {
    drawerToggle.addEventListener('click', () => {
      const isHidden = drawerPanel.hasAttribute('hidden');
      if (isHidden) {
        drawerPanel.removeAttribute('hidden');
      } else {
        drawerPanel.setAttribute('hidden', 'hidden');
      }
      drawerToggle.classList.toggle('open');
    });
  }

  drawerItems.forEach(item => {
    item.addEventListener('click', () => {
      const pack   = item.dataset.pack;
      const avatar = item.dataset.avatar;

      // on met √† jour le radio cach√©
      drawerRadio.value = pack;
      drawerRadio.setAttribute('data-avatar', avatar);
      drawerRadio.checked = true;

      // on applique la s√©lection (met √† jour le hidden avatar + surbrillance)
      applySelection(drawerRadio);

      // √©tat visuel dans la liste
      drawerItems.forEach(i => i.classList.remove('active'));
      item.classList.add('active');

      // on peut refermer le tiroir pour simplifier
      if (drawerPanel) {
        drawerPanel.setAttribute('hidden', 'hidden');
        drawerToggle.classList.remove('open');
      }
    });
  });

  // ====== Joystick 2D ======
  const joy  = document.getElementById('joy');
  const thumb= document.getElementById('thumb');
  const ix   = document.getElementById('persona_x');
  const iy   = document.getElementById('persona_y');
  const size = 220, radius = size/2;
  let dragging = false;

  function setThumbFromEvent(ev){
    const rect = joy.getBoundingClientRect();
    let x = (ev.clientX ?? (ev.touches && ev.touches[0].clientX)) - rect.left;
    let y = (ev.clientY ?? (ev.touches && ev.touches[0].clientY)) - rect.top;
    x = Math.max(0, Math.min(size, x));
    y = Math.max(0, Math.min(size, y));
    const nx = (x - radius) / radius;
    const ny = (radius - y) / radius;
    ix.value = nx.toFixed(2);
    iy.value = ny.toFixed(2);
    thumb.style.left = (x - 10) + 'px';
    thumb.style.top  = (y - 10) + 'px';
  }
  function startDrag(ev){ dragging = true; setThumbFromEvent(ev); }
  function moveDrag(ev){ if(dragging){ ev.preventDefault(); setThumbFromEvent(ev); } }
  function endDrag(){ dragging = false; }

  joy.addEventListener('mousedown', startDrag);
  joy.addEventListener('mousemove', moveDrag);
  window.addEventListener('mouseup', endDrag);
  joy.addEventListener('touchstart', startDrag, {passive:false});
  joy.addEventListener('touchmove',  moveDrag,  {passive:false});
  window.addEventListener('touchend', endDrag);

  // position initiale au centre
  thumb.style.left = (radius - 10) + 'px';
  thumb.style.top  = (radius - 10) + 'px';
</script>

{% endblock %}
