{% extends "base.html" %}
{% block content %}
<h1>Configurer votre chatbot</h1>
<p class="hint">Choisissez un métier, une couleur, ajustez la personnalité, ajoutez votre message d’accueil et vos coordonnées.</p>

<form class="form" method="post" id="config-form">
  <!-- Métier -->
  <div>
    <div class="label">Métier</div>
    <div class="avatar-grid" id="packs">
      <label class="avatar-card" data-pack="avocat">
        <input type="radio" name="pack" value="avocat" checked>
        <img src="{{ url_for('static', filename='avocat.jpg') }}" onerror="this.src='https://api.dicebear.com/8.x/shapes/png?seed=avocat'">
        <span>Avocat</span>
      </label>
      <label class="avatar-card" data-pack="medecin">
        <input type="radio" name="pack" value="medecin">
        <img src="{{ url_for('static', filename='medecin.jpg') }}" onerror="this.src='https://api.dicebear.com/8.x/shapes/png?seed=medecin'">
        <span>Médecin</span>
      </label>
      <label class="avatar-card" data-pack="immo">
        <input type="radio" name="pack" value="immo">
        <img src="{{ url_for('static', filename='immo.jpg') }}" onerror="this.src='https://api.dicebear.com/8.x/shapes/png?seed=immo'">
        <span>Immobilier</span>
      </label>
    </div>
    <input type="hidden" name="avatar" id="avatar-file" value="avocat.jpg">
  </div>

  <!-- Couleur -->
  <div>
    <div class="label">Couleur</div>
    <div class="swatches" id="swatches">
      <label class="swatch selected"><input type="radio" name="color" value="#4F46E5" checked><span class="chip" style="background:#4F46E5"></span></label>
      <label class="swatch"><input type="radio" name="color" value="#16A34A"><span class="chip" style="background:#16A34A"></span></label>
      <label class="swatch"><input type="radio" name="color" value="#0284C7"><span class="chip" style="background:#0284C7"></span></label>
      <label class="swatch"><input type="radio" name="color" value="#F59E0B"><span class="chip" style="background:#F59E0B"></span></label>
      <label class="swatch"><input type="radio" name="color" value="#DC2626"><span class="chip" style="background:#DC2626"></span></label>
      <label class="swatch"><input type="radio" name="color" value="#9333EA"><span class="chip" style="background:#9333EA"></span></label>
    </div>
  </div>

  <!-- Curseur 2D -->
  <div>
    <div class="label">Personnalité</div>
    <div class="axes-wrap">
      <div class="axes" id="axes">
        <div class="axes-dot" id="axes-dot"></div>
        <div class="axes-line h"></div><div class="axes-line v"></div>
        <div class="axes-label top">Chaleureuse</div>
        <div class="axes-label bottom">Précise</div>
        <div class="axes-label left">Empathique</div>
        <div class="axes-label right">Efficace</div>
      </div>
      <input type="hidden" name="persona_x" id="persona_x" value="0">
      <input type="hidden" name="persona_y" id="persona_y" value="0">
    </div>
  </div>

  <!-- Greeting -->
  <div>
    <div class="label">Message d’accueil</div>
    <input type="text" name="greeting" value="Bonjour, je suis Betty. Comment puis-je vous aider ?">
  </div>

  <!-- Coordonnées (pour alimenter le bot vendu) -->
  <div>
    <div class="label">Vos coordonnées (tél., adresse, horaires, email…)</div>
    <textarea name="contact_info" rows="3" placeholder="Ex. Cabinet Dupond — 02 43 00 00 00 — 12 rue de la Paix, 72000 Le Mans — Horaires: Lun-Ven 9h-18h — contact@exemple.com"></textarea>
  </div>

  <button class="btn primary" type="submit">Enregistrer et payer</button>
</form>

<script>
  // Sélection visuelle des cartes métier
  const packs = document.getElementById('packs');
  const avatarFile = document.getElementById('avatar-file');
  packs.querySelectorAll('.avatar-card').forEach(card=>{
    if(card.querySelector('input').checked) card.classList.add('selected');
    card.addEventListener('click', ()=>{
      packs.querySelectorAll('.avatar-card').forEach(c=>c.classList.remove('selected'));
      card.classList.add('selected');
      card.querySelector('input').checked = true;
      const p = card.dataset.pack;
      avatarFile.value = (p==='avocat'?'avocat.jpg':(p==='medecin'?'medecin.jpg':'immo.jpg'));
    });
  });

  // Sélection visuelle des swatches
  const swatches = document.getElementById('swatches');
  swatches.querySelectorAll('.swatch').forEach(s=>{
    s.addEventListener('click', ()=>{
      swatches.querySelectorAll('.swatch').forEach(x=>x.classList.remove('selected'));
      s.classList.add('selected');
      s.querySelector('input').checked = true;
    });
  });

  // Curseur 2D
  const axes = document.getElementById('axes'); const dot = document.getElementById('axes-dot');
  const inputX = document.getElementById('persona_x'); const inputY = document.getElementById('persona_y');
  function setDotAt(clientX, clientY){
    const r = axes.getBoundingClientRect();
    const x = Math.max(0, Math.min(clientX - r.left, r.width));
    const y = Math.max(0, Math.min(clientY - r.top,  r.height));
    dot.style.left = (x-9)+'px'; dot.style.top = (y-9)+'px';
    inputX.value = ((x/r.width)*2-1).toFixed(2);
    inputY.value = (-((y/r.height)*2-1)).toFixed(2);
  }
  setTimeout(()=>{ const r=axes.getBoundingClientRect(); setDotAt(r.left+r.width/2, r.top+r.height/2); },0);
  axes.addEventListener('pointerdown', e=>{
    setDotAt(e.clientX, e.clientY);
    const move=ev=>setDotAt(ev.clientX, ev.clientY);
    const up=()=>{window.removeEventListener('pointermove',move);window.removeEventListener('pointerup',up);}
    window.addEventListener('pointermove',move); window.addEventListener('pointerup',up);
  });
</script>
{% endblock %}
