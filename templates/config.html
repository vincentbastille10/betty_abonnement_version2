{% extends "base.html" %}
{% block content %}

<h1>Configurer votre chatbot</h1>
<p class="intro">Choisissez un m√©tier, une couleur, ajustez la personnalit√© et personnalisez le message d‚Äôaccueil.</p>

<form method="POST" action="{{ url_for('config_page') }}" id="cfg-form" class="cfg-grid">

  <!-- M√©tier / Avatar -->
  <section class="card">
    <h2>M√©tier</h2>
    <div class="avatar-grid">

      <!-- Avocat -->
      <label class="avatar-card selected">
        <input type="radio" name="pack" value="avocat" data-avatar="avocat.jpg" checked>
        <img src="{{ url_for('static', filename='avocat.jpg') }}" alt="Avocat">
        <div class="a-label">Avocat</div>
      </label>

      <!-- M√©decin -->
      <label class="avatar-card">
        <input type="radio" name="pack" value="medecin" data-avatar="medecin.jpg">
        <img src="{{ url_for('static', filename='medecin.jpg') }}" alt="M√©decin">
        <div class="a-label">M√©decin</div>
      </label>

      <!-- Immobilier -->
      <label class="avatar-card">
        <input type="radio" name="pack" value="immo" data-avatar="immo.jpg">
        <img src="{{ url_for('static', filename='immo.jpg') }}" alt="Immobilier">
        <div class="a-label">Immobilier</div>
      </label>

    </div>
    <small class="hint">Cliquez pour s√©lectionner. Taille d‚Äôaffichage : 4 cm √ó 4 cm.</small>

    <!-- üîí Un SEUL avatar envoy√© au back -->
    <input type="hidden" name="avatar" id="avatar-hidden" value="avocat.jpg">
  </section>

  <!-- Couleurs -->
  <section class="card">
    <h2>Couleur</h2>
    <div class="color-grid">
      <label class="color-swatch" style="--c:#4F46E5">
        <input type="radio" name="color" value="#4F46E5" checked>
      </label>
      <label class="color-swatch" style="--c:#16A34A">
        <input type="radio" name="color" value="#16A34A">
      </label>
      <label class="color-swatch" style="--c:#0284C7">
        <input type="radio" name="color" value="#0284C7">
      </label>
      <label class="color-swatch" style="--c:#DB2777">
        <input type="radio" name="color" value="#DB2777">
      </label>
      <label class="color-swatch" style="--c:#F59E0B">
        <input type="radio" name="color" value="#F59E0B">
      </label>
      <label class="color-swatch" style="--c:#10B981">
        <input type="radio" name="color" value="#10B981">
      </label>
    </div>
  </section>

  <!-- Personnalit√© (curseur 2D) -->
  <section class="card">
    <h2>Personnalit√©</h2>
    <div class="axes-wrap">
      <div class="axis-label top">Chaleureuse</div>
      <div class="axis-label left">Empathique</div>
      <div class="joystick" id="joy">
        <div class="thumb" id="thumb"></div>
      </div>
      <div class="axis-label right">Efficace</div>
      <div class="axis-label bottom">Pr√©cise</div>
    </div>
    <input type="hidden" name="persona_x" id="persona_x" value="0">
    <input type="hidden" name="persona_y" id="persona_y" value="0">
    <small class="hint">D√©placez le curseur : gauche = empathique, droite = efficace, haut = chaleureuse, bas = pr√©cise.</small>
  </section>

  <!-- Contenus -->
  <section class="card">
    <h2>Contenus</h2>
    <label class="field">
      <span>Message d‚Äôaccueil</span>
      <input type="text" name="greeting" placeholder="Bonjour, je suis Betty. Comment puis-je vous aider ?">
    </label>

    <label class="field">
      <span>Informations √©tablissement (t√©l√©phone, email, adresse, horaires‚Ä¶)</span>
      <textarea name="contact_info" rows="4" placeholder="Nom : Cabinet Dupont
T√©l√©phone : 02 43 XX XX XX
Email : contact@cabinet-dupont.fr
Adresse : 12 rue de la R√©publique, 72000 Le Mans
Horaires : Lun‚ÄìVen 9h‚Äì12h / 14h‚Äì18h"></textarea>
    </label>
  </section>

  <!-- CTA -->
  <div class="cta">
    <button type="submit" class="btn primary big">Enregistrer et s‚Äôabonner</button>
  </div>
</form>

<script>
  // ====== Pack <-> Avatar : synchro 100% fiable ======
  const packRadios   = document.querySelectorAll('input[type="radio"][name="pack"]');
  const avatarHidden = document.getElementById('avatar-hidden');
  const cards        = document.querySelectorAll('.avatar-card');

  function applySelection(radio){
    // 1) avatar (valeur envoy√©e au backend)
    const file = radio.getAttribute('data-avatar') || 'avocat.jpg';
    avatarHidden.value = file;

    // 2) carte active (surbrillance)
    cards.forEach(c => c.classList.remove('selected'));
    const card = radio.closest('.avatar-card');
    if(card) card.classList.add('selected');
  }

  // Initialisation (au cas o√π le serveur pr√©renseigne un pack)
  document.addEventListener('DOMContentLoaded', () => {
    const checked = document.querySelector('input[name="pack"]:checked');
    if (checked) applySelection(checked);
  });

  // Changement de pack
  packRadios.forEach(r => {
    r.addEventListener('change', () => applySelection(r));
    // Support clic sur toute la carte (label)
    const card = r.closest('.avatar-card');
    if(card){
      card.addEventListener('click', () => {
        r.checked = true;
        applySelection(r);
      });
    }
  });

  // ====== Joystick 2D ======
  const joy  = document.getElementById('joy');
  const thumb= document.getElementById('thumb');
  const ix   = document.getElementById('persona_x');
  const iy   = document.getElementById('persona_y');
  const size = 220, radius = size/2;
  let dragging = false;

  function setThumbFromEvent(ev){
    const rect = joy.getBoundingClientRect();
    let x = (ev.clientX ?? (ev.touches && ev.touches[0].clientX)) - rect.left;
    let y = (ev.clientY ?? (ev.touches && ev.touches[0].clientY)) - rect.top;
    x = Math.max(0, Math.min(size, x));
    y = Math.max(0, Math.min(size, y));
    const nx = (x - radius) / radius;
    const ny = (radius - y) / radius;
    ix.value = nx.toFixed(2);
    iy.value = ny.toFixed(2);
    thumb.style.left = (x - 10) + 'px';
    thumb.style.top  = (y - 10) + 'px';
  }
  function startDrag(ev){ dragging = true; setThumbFromEvent(ev); }
  function moveDrag(ev){ if(dragging){ ev.preventDefault(); setThumbFromEvent(ev); } }
  function endDrag(){ dragging = false; }

  joy.addEventListener('mousedown', startDrag);
  joy.addEventListener('mousemove', moveDrag);
  window.addEventListener('mouseup', endDrag);
  joy.addEventListener('touchstart', startDrag, {passive:false});
  joy.addEventListener('touchmove',  moveDrag,  {passive:false});
  window.addEventListener('touchend', endDrag);

  // position initiale au centre
  thumb.style.left = (radius - 10) + 'px';
  thumb.style.top  = (radius - 10) + 'px';
</script>

{% endblock %}
