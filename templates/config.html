{% extends "base.html" %}
{% block content %}

<style>
  .metier-drawer {
    margin-top: 1rem;
  }
  .drawer-toggle {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.5rem 1rem;
    border-radius: 999px;
    border: 1px solid #4F46E5;
    background: #0f172a;
    color: #e5e7eb;
    font-size: 0.9rem;
    cursor: pointer;
  }
  .drawer-toggle.open {
    background: #4F46E5;
    color: #ffffff;
  }
  .selected-metier-label {
    margin-top: 0.5rem;
    font-size: 0.85rem;
    color: #e5e7eb;
  }
  .selected-metier-label strong {
    color: #ffffff;
  }

  /* Bloc avatar s√©lectionn√© + l√©gende */
  .selected-metier-avatar {
    margin-top: 0.4rem;
    display: inline-flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 0.85rem;
    color: #e5e7eb;
  }
  .selected-metier-avatar img.avatar-preview-img {
    width: 52px;
    height: 52px;
    border-radius: 999px;
    object-fit: cover;
    border: 1px solid #4F46E5;
    background: #020617;
  }
  .selected-metier-avatar-text {
    display: flex;
    flex-direction: column;
    gap: 0.15rem;
  }
  .selected-metier-avatar-text span {
    font-weight: 500;
    color: #e5e7eb;
  }
  .selected-metier-avatar-text small {
    font-size: 0.75rem;
    color: #9ca3af;
  }

  .drawer-panel {
    margin-top: 0.75rem;
    padding: 0.75rem;
    border-radius: 0.75rem;
    background: #020617;
    border: 1px solid #1f2937;
  }
  .drawer-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }
  .drawer-chip {
    border-radius: 999px;
    padding: 0.4rem 0.9rem;
    border: 1px solid #4b5563;
    background: #0b1120;
    color: #e5e7eb;
    font-size: 0.85rem;
    cursor: pointer;
    transition: background 0.15s ease, border-color 0.15s ease, transform 0.05s ease;
  }
  .drawer-chip:hover {
    border-color: #4F46E5;
    transform: translateY(-1px);
  }
  .drawer-chip.active {
    border-color: #4F46E5;
    background: #4F46E5;
    color: #ffffff;
  }
</style>

<h1>Configurer votre chatbot</h1>
<p class="intro">Choisissez un m√©tier, une couleur, ajustez la personnalit√© et personnalisez le message d‚Äôaccueil.</p>

<form method="POST" action="{{ url_for('config_page') }}" id="cfg-form" class="cfg-grid">

  <!-- M√©tier / Avatar -->
  <section class="card">
    <h2>M√©tier</h2>
    <p class="hint">S√©lectionnez un avatar principal ou ouvrez le tiroir pour acc√©der √† tous les m√©tiers Betty.</p>

    <div class="avatar-grid">

      <!-- Avocat -->
      <label class="avatar-card selected">
        <input type="radio" name="pack" value="avocat" data-avatar="avocat.jpg" checked>
        <img src="{{ url_for('static', filename='avocat.jpg') }}" alt="Avocat">
        <div class="a-label">Avocat</div>
      </label>

      <!-- M√©decin -->
      <label class="avatar-card">
        <input type="radio" name="pack" value="medecin" data-avatar="medecin.jpg">
        <img src="{{ url_for('static', filename='medecin.jpg') }}" alt="M√©decin">
        <div class="a-label">M√©decin</div>
      </label>

      <!-- Immobilier -->
      <label class="avatar-card">
        <input type="radio" name="pack" value="immo" data-avatar="immo.jpg">
        <img src="{{ url_for('static', filename='immo.jpg') }}" alt="Immobilier">
        <div class="a-label">Immobilier</div>
      </label>

    </div>
    <small class="hint">Cliquez pour s√©lectionner. Taille d‚Äôaffichage : 4 cm √ó 4 cm.</small>

    <!-- üîí Un SEUL avatar envoy√© au back -->
    <input type="hidden" name="avatar" id="avatar-hidden" value="avocat.jpg">

    <!-- ===== TIROIR METIER ===== -->
    <div class="metier-drawer">
      <button type="button" class="drawer-toggle" id="drawer-toggle">
        Plus de m√©tiers : faites d√©rouler le menu
      </button>

      <p id="metier-selected-label" class="selected-metier-label">
        M√©tier s√©lectionn√© : <strong>Avocat</strong>. Continuez la configuration de votre bot.
      </p>

      <!-- Aper√ßu avatar + l√©gende -->
      <div class="selected-metier-avatar">
        <img id="avatar-preview"
             src="{{ url_for('static', filename='avocat.jpg') }}"
             alt="Avatar s√©lectionn√©"
             class="avatar-preview-img">
        <div class="selected-metier-avatar-text">
          <span>Avatar s√©lectionn√©</span>
          <small>Ce sera la photo utilis√©e dans votre Chatbot intelligent Betty.</small>
        </div>
      </div>

      <div class="drawer-panel" id="drawer-panel" hidden>
        <p class="hint">Cliquez sur votre m√©tier pour charger l‚Äôavatar et le pack correspondant.</p>

        <!-- radio cach√© qui portera le pack choisi dans le tiroir -->
        <input type="radio" name="pack" id="drawer-pack-radio" value="" data-avatar="" style="display:none">

        <div class="drawer-grid">
          <!-- ordre alphab√©tique sur le label humain -->
          <button type="button" class="drawer-chip"
                  data-pack="betty_aide_a_domicile"
                  data-avatar="Betty_aide_a_domicile.png"
                  data-label="Aide √† domicile">
            Aide √† domicile
          </button>

          <button type="button" class="drawer-chip"
                  data-pack="betty_aide_a_dom"
                  data-avatar="Betty_aide_a_dom.png"
                  data-label="Aide √† domicile (rapide)">
            Aide √† domicile (rapide)
          </button>

          <button type="button" class="drawer-chip"
                  data-pack="betty_architecte"
                  data-avatar="Betty_architecte.png"
                  data-label="Architecte">
            Architecte
          </button>

          <button type="button" class="drawer-chip"
                  data-pack="betty_artisan"
                  data-avatar="Betty_artisan.png"
                  data-label="Artisan">
            Artisan
          </button>

          <button type="button" class="drawer-chip"
                  data-pack="betty_assistance_scolaire"
                  data-avatar="Betty_assistance_scolaire.png"
                  data-label="Assistance scolaire">
            Assistance scolaire
          </button>

          <button type="button" class="drawer-chip"
                  data-pack="betty_assurance"
                  data-avatar="Betty_assurance.png"
                  data-label="Assurance">
            Assurance
          </button>

          <button type="button" class="drawer-chip"
                  data-pack="betty_coach"
                  data-avatar="Betty_coach.png"
                  data-label="Coach">
            Coach
          </button>

          <button type="button" class="drawer-chip"
                  data-pack="betty_coiffeur"
                  data-avatar="Betty_coiffeur.png"
                  data-label="Coiffeur">
            Coiffeur
          </button>

          <button type="button" class="drawer-chip"
                  data-pack="betty_dentiste"
                  data-avatar="Betty_dentiste.png"
                  data-label="Dentiste">
            Dentiste
          </button>

          <button type="button" class="drawer-chip"
                  data-pack="betty_dj"
                  data-avatar="Betty_DJ.png"
                  data-label="DJ">
            DJ
          </button>

          <button type="button" class="drawer-chip"
                  data-pack="betty_estheticienne"
                  data-avatar="Betty_estheticienne.png"
                  data-label="Esth√©ticienne">
            Esth√©ticienne
          </button>

          <button type="button" class="drawer-chip"
                  data-pack="betty_garde_denfant"
                  data-avatar="Betty_garde_denfant.png"
                  data-label="Garde d‚Äôenfant">
            Garde d‚Äôenfant
          </button>

          <button type="button" class="drawer-chip"
                  data-pack="betty_graphiste"
                  data-avatar="Betty_graphiste.png"
                  data-label="Graphiste">
            Graphiste
          </button>

          <button type="button" class="drawer-chip"
                  data-pack="betty_infirmiere"
                  data-avatar="Betty_infirmiere.png"
                  data-label="Infirmi√®re">
            Infirmi√®re
          </button>

          <button type="button" class="drawer-chip"
                  data-pack="betty_kine"
                  data-avatar="Betty_kine.png"
                  data-label="Kin√©">
            Kin√©
          </button>

          <button type="button" class="drawer-chip"
                  data-pack="betty_marketing"
                  data-avatar="Betty_marketing.png"
                  data-label="Marketing">
            Marketing
          </button>

          <button type="button" class="drawer-chip"
                  data-pack="betty_mecano"
                  data-avatar="Betty_mecano.png"
                  data-label="M√©cano">
            M√©cano
          </button>

          <button type="button" class="drawer-chip"
                  data-pack="betty_menage"
                  data-avatar="Betty_menage.png"
                  data-label="M√©nage">
            M√©nage
          </button>

          <button type="button" class="drawer-chip"
                  data-pack="betty_nutritioniste"
                  data-avatar="Betty_nutritioniste.png"
                  data-label="Nutritionniste">
            Nutritionniste
          </button>

          <button type="button" class="drawer-chip"
                  data-pack="betty_osteopate"
                  data-avatar="Betty_osteopate.png"
                  data-label="Ost√©opathe">
            Ost√©opathe
          </button>

          <button type="button" class="drawer-chip"
                  data-pack="betty_paysagiste"
                  data-avatar="Betty_paysagiste.png"
                  data-label="Paysagiste">
            Paysagiste
          </button>

          <button type="button" class="drawer-chip"
                  data-pack="betty_photographe"
                  data-avatar="Betty_photographe.png"
                  data-label="Photographe">
            Photographe
          </button>

          <button type="button" class="drawer-chip"
                  data-pack="betty_plombier"
                  data-avatar="Betty_plombier.png"
                  data-label="Plombier">
            Plombier
          </button>

          <button type="button" class="drawer-chip"
                  data-pack="betty_serrurier"
                  data-avatar="Betty_serrurier.png"
                  data-label="Serrurier">
            Serrurier
          </button>

          <button type="button" class="drawer-chip"
                  data-pack="betty_sophrologue"
                  data-avatar="Betty_sophrologue.png"
                  data-label="Sophrologue">
            Sophrologue
          </button>

          <button type="button" class="drawer-chip"
                  data-pack="betty_soutien_scolaire"
                  data-avatar="Betty_soutien_scolaire.png"
                  data-label="Soutien scolaire">
            Soutien scolaire
          </button>

          <button type="button" class="drawer-chip"
                  data-pack="betty_trader"
                  data-avatar="Betty_trader.png"
                  data-label="Trader">
            Trader
          </button>

          <button type="button" class="drawer-chip"
                  data-pack="betty_traiteur"
                  data-avatar="Betty_traiteur.png"
                  data-label="Traiteur">
            Traiteur
          </button>

          <button type="button" class="drawer-chip"
                  data-pack="betty_verrier"
                  data-avatar="Betty_verrier.png"
                  data-label="Verrier">
            Verrier
          </button>

          <button type="button" class="drawer-chip"
                  data-pack="betty_yoga"
                  data-avatar="Betty_yoga.png"
                  data-label="Prof de yoga">
            Prof de yoga
          </button>
        </div>
      </div>
    </div>
    <!-- ===== /TIROIR METIER ===== -->

  </section>

  <!-- Couleurs -->
  <section class="card">
    <h2>Couleur</h2>
    <div class="color-grid">
      <label class="color-swatch" style="--c:#4F46E5">
        <input type="radio" name="color" value="#4F46E5" checked>
      </label>
      <label class="color-swatch" style="--c:#16A34A">
        <input type="radio" name="color" value="#16A34A">
      </label>
      <label class="color-swatch" style="--c:#0284C7">
        <input type="radio" name="color" value="#0284C7">
      </label>
      <label class="color-swatch" style="--c:#DB2777">
        <input type="radio" name="color" value="#DB2777">
      </label>
      <label class="color-swatch" style="--c:#F59E0B">
        <input type="radio" name="color" value="#F59E0B">
      </label>
      <label class="color-swatch" style="--c:#10B981">
        <input type="radio" name="color" value="#10B981">
      </label>
    </div>
  </section>

  <!-- Personnalit√© (curseur 2D) -->
  <section class="card">
    <h2>Personnalit√©</h2>
    <div class="axes-wrap">
      <div class="axis-label top">Chaleureuse</div>
      <div class="axis-label left">Empathique</div>
      <div class="joystick" id="joy">
        <div class="thumb" id="thumb"></div>
      </div>
      <div class="axis-label right">Efficace</div>
      <div class="axis-label bottom">Pr√©cise</div>
    </div>
    <input type="hidden" name="persona_x" id="persona_x" value="0">
    <input type="hidden" name="persona_y" id="persona_y" value="0">
    <small class="hint">D√©placez le curseur : gauche = empathique, droite = efficace, haut = chaleureuse, bas = pr√©cise.</small>
  </section>

  <!-- Contenus -->
  <section class="card">
    <h2>Contenus</h2>
    <label class="field">
      <span>Message d‚Äôaccueil</span>
      <input type="text" name="greeting" placeholder="Bonjour, je suis Betty. Comment puis-je vous aider ?">
    </label>

    <label class="field">
      <span>Informations √©tablissement (t√©l√©phone, email, adresse, horaires‚Ä¶)</span>
      <textarea name="contact_info" rows="4" placeholder="Nom : Cabinet Dupont
T√©l√©phone : 02 43 XX XX XX
Email : contact@cabinet-dupont.fr
Adresse : 12 rue de la R√©publique, 72000 Le Mans
Horaires : Lun‚ÄìVen 9h‚Äì12h / 14h‚Äì18h"></textarea>
    </label>
  </section>

  <!-- CTA -->
  <div class="cta">
    <button type="submit" class="btn primary big">Enregistrer et s‚Äôabonner</button>
  </div>
</form>

<script>
  // ====== Pack <-> Avatar : synchro 100% fiable ======
  const AVATAR_BASE = "{{ url_for('static', filename='') }}";

  const packRadios   = document.querySelectorAll('input[type="radio"][name="pack"]');
  const avatarHidden = document.getElementById('avatar-hidden');
  const cards        = document.querySelectorAll('.avatar-card');
  const metierLabel  = document.getElementById('metier-selected-label');

  function updateMetierLabelFromRadio(radio) {
    if (!metierLabel || !radio) return;
    let txt = "";

    const card = radio.closest('.avatar-card');
    if (card) {
      const lbl = card.querySelector('.a-label');
      if (lbl) txt = lbl.textContent.trim();
    } else if (radio.dataset && radio.dataset.label) {
      txt = radio.dataset.label;
    } else if (radio.value) {
      txt = radio.value.replace(/^betty_/, "").replace(/_/g, " ");
      txt = txt.charAt(0).toUpperCase() + txt.slice(1);
    }

    if (!txt) txt = "Avocat";
    metierLabel.innerHTML = 'M√©tier s√©lectionn√© : <strong>' + txt + '</strong>. Continuez la configuration de votre bot.';
  }

  function applySelection(radio){
    const file = radio.getAttribute('data-avatar') || 'avocat.jpg';
    avatarHidden.value = file;

    // met √† jour l‚Äôaper√ßu avatar
    const preview = document.getElementById('avatar-preview');
    if (preview) {
      preview.src = AVATAR_BASE + file;
    }

    cards.forEach(c => c.classList.remove('selected'));
    const card = radio.closest('.avatar-card');
    if(card) card.classList.add('selected');

    updateMetierLabelFromRadio(radio);
  }

  document.addEventListener('DOMContentLoaded', () => {
    const checked = document.querySelector('input[name="pack"]:checked');
    if (checked) applySelection(checked);
  });

  packRadios.forEach(r => {
    r.addEventListener('change', () => applySelection(r));
    const card = r.closest('.avatar-card');
    if(card){
      card.addEventListener('click', () => {
        r.checked = true;
        applySelection(r);
      });
    }
  });

  // ====== TIROIR METIER ======
  const drawerToggle   = document.getElementById('drawer-toggle');
  const drawerPanel    = document.getElementById('drawer-panel');
  const drawerRadio    = document.getElementById('drawer-pack-radio');
  const drawerChips    = document.querySelectorAll('.drawer-chip');

  if (drawerToggle && drawerPanel) {
    drawerToggle.addEventListener('click', () => {
      const isHidden = drawerPanel.hasAttribute('hidden');
      if (isHidden) {
        drawerPanel.removeAttribute('hidden');
      } else {
        drawerPanel.setAttribute('hidden', 'hidden');
      }
      drawerToggle.classList.toggle('open');
    });
  }

  drawerChips.forEach(chip => {
    chip.addEventListener('click', () => {
      const pack   = chip.dataset.pack;
      const avatar = chip.dataset.avatar;
      const label  = chip.dataset.label || pack;

      // radio cach√© = pack m√©tier
      drawerRadio.value = pack;
      drawerRadio.setAttribute('data-avatar', avatar);
      drawerRadio.dataset.label = label;
      drawerRadio.checked = true;

      // visuel : on d√©sactive les avatars principaux
      cards.forEach(c => c.classList.remove('selected'));

      // maj avatar + texte de confirmation
      applySelection(drawerRadio);

      // √©tat visuel des chips
      drawerChips.forEach(c => c.classList.remove('active'));
      chip.classList.add('active');

      // on referme le tiroir pour un flow plus fluide
      drawerPanel.setAttribute('hidden', 'hidden');
      drawerToggle.classList.remove('open');
    });
  });

  // ====== Joystick 2D ======
  const joy  = document.getElementById('joy');
  const thumb= document.getElementById('thumb');
  const ix   = document.getElementById('persona_x');
  const iy   = document.getElementById('persona_y');
  const size = 220, radius = size/2;
  let dragging = false;

  function setThumbFromEvent(ev){
    const rect = joy.getBoundingClientRect();
    let x = (ev.clientX ?? (ev.touches && ev.touches[0].clientX)) - rect.left;
    let y = (ev.clientY ?? (ev.touches && ev.touches[0].clientY)) - rect.top;
    x = Math.max(0, Math.min(size, x));
    y = Math.max(0, Math.min(size, y));
    const nx = (x - radius) / radius;
    const ny = (radius - y) / radius;
    ix.value = nx.toFixed(2);
    iy.value = ny.toFixed(2);
    thumb.style.left = (x - 10) + 'px';
    thumb.style.top  = (y - 10) + 'px';
  }
  function startDrag(ev){ dragging = true; setThumbFromEvent(ev); }
  function moveDrag(ev){ if(dragging){ ev.preventDefault(); setThumbFromEvent(ev); } }
  function endDrag(){ dragging = false; }

  joy.addEventListener('mousedown', startDrag);
  joy.addEventListener('mousemove', moveDrag);
  window.addEventListener('mouseup', endDrag);
  joy.addEventListener('touchstart', startDrag, {passive:false});
  joy.addEventListener('touchmove',  moveDrag,  {passive:false});
  window.addEventListener('touchend', endDrag);

  thumb.style.left = (radius - 10) + 'px';
  thumb.style.top  = (radius - 10) + 'px';
</script>

{% endblock %}
