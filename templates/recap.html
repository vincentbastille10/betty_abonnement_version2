<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Code d’intégration — {{ full_name }}</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <style>
    :root{
      --bg:#0b0f1e; --card:#0e1324; --ink:#e8ecff; --muted:#a7afc8;
      --line:rgba(255,255,255,.08); --accent:#3b82f6; --accent2:#1d4ed8;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.5 Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    .wrap{max-width:1060px;margin:24px auto;padding:0 16px}
    h1{margin:0 0 2px;font-size:20px}
    .sub{color:var(--muted);margin-bottom:18px}

    .grid{display:grid;grid-template-columns:1fr 420px;gap:18px}
    @media (max-width:980px){ .grid{grid-template-columns:1fr} }

    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .tag{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid var(--line);border-radius:999px;color:var(--muted);font-weight:600}

    .tabs{display:flex;gap:8px;margin:12px 0}
    .tab{padding:10px 14px;border:1px solid var(--line);border-radius:999px;background:#0c1226;color:var(--ink);cursor:pointer}
    .tab.active{background:var(--accent);border-color:var(--accent);color:#fff}

    textarea.code{
      width:100%;min-height:280px;background:#0b1022;color:#d8e0ff;border:1px solid var(--line);
      border-radius:12px;padding:14px 14px;font:12px/1.45 ui-monospace,Menlo,Consolas,monospace;white-space:pre;overflow:auto
    }

    .actions{display:flex;gap:8px;align-items:center;margin-top:10px}
    .btn{background:var(--accent);color:#fff;border:0;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn:active{transform:translateY(1px)} .btn.alt{background:#18203b}

    .previewBox{
      height:640px;border-radius:16px;overflow:hidden;border:1px solid var(--line);
      background:#0a0e1c;box-shadow:0 10px 30px rgba(0,0,0,.28)
    }
    .previewBox iframe{width:100%;height:100%;border:0}
    .okline{color:#8bffa5}
    .warn{color:#ffdf7a}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>{{ full_name }}</h1>
    <div class="sub">Pack : {{ pack }} — <span class="okline">Votre bot est prêt ✅</span></div>

    {# ----------------- Prépare l’URL d’embed (unique source de vérité) ----------------- #}
    {% set _buyer = (buyer_email or '') %}
    {% set embed_src = base_url ~ '/chat?public_id=' ~ (public_id|urlencode) ~ '&embed=1' ~ ('&buyer_email=' ~ (_buyer|urlencode) if _buyer else '') %}

    {# ----------------- Codes d’intégration (A: iframe, B: script) ----------------- #}
    {% set code_iframe %}
<!-- Betty Bot AI — affichage direct (Wix/Webflow/Squarespace ou HTML simple) -->
<div style="position:relative; width:100%; max-width:420px; height:620px; margin:0 auto;">
  <iframe
    src="{{ embed_src }}"
    title="{{ full_name }}"
    style="width:100%; height:100%; border:0; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.25); background:#0b0f1e;"
    loading="lazy"
    referrerpolicy="no-referrer-when-downgrade"
    allow="clipboard-read; clipboard-write; microphone; autoplay"></iframe>
</div>
    {% endset %}

    {% set mount_id = 'betty_mount_' ~ (public_id|replace({'-':'_'})) %}
    {% set code_script %}
<!-- Betty Bot AI — injection script (ajoute dynamiquement un iFrame) -->
<div id="{{ mount_id }}"></div>
<script>
(function(){
  var el = document.getElementById({{ mount_id|tojson }});
  if(!el) return;
  var box = document.createElement('div');
  box.style.position = 'relative';
  box.style.width    = '100%';
  box.style.maxWidth = '420px';
  box.style.height   = '620px';
  box.style.margin   = '0 auto';

  var fr = document.createElement('iframe');
  fr.src   = {{ embed_src|tojson }};
  fr.title = {{ full_name|tojson }};
  fr.style.width  = '100%';
  fr.style.height = '100%';
  fr.style.border = '0';
  fr.style.borderRadius = '16px';
  fr.style.boxShadow    = '0 10px 30px rgba(0,0,0,.25)';
  fr.style.background   = '#0b0f1e';
  fr.setAttribute('loading','lazy');
  fr.setAttribute('referrerpolicy','no-referrer-when-downgrade');
  fr.setAttribute('allow','clipboard-read; clipboard-write; microphone; autoplay');

  box.appendChild(fr);
  el.appendChild(box);
})();
</script>
    {% endset %}

    <div class="grid">
      <!-- Colonne gauche : codes + boutons copier -->
      <div class="card">
        <div class="row">
          <div class="tag">Nom complet du bot&nbsp;•&nbsp;<b>{{ full_name }}</b></div>
          <div class="tag">Public ID&nbsp;•&nbsp;<b>{{ public_id }}</b></div>
          {% if buyer_email %}<div class="tag">Réception leads&nbsp;•&nbsp;<b>{{ buyer_email }}</b></div>{% endif %}
        </div>

        <div class="tabs">
          <button class="tab active" id="tabA">Intégration (iframe — Wix recommandé)</button>
          <button class="tab" id="tabB">Avancé (snippet &lt;script&gt;)</button>
        </div>

        <div id="panelA">
          <textarea class="code" id="codeA" readonly spellcheck="false">{{ code_iframe|e }}</textarea>
          <div class="actions">
            <button class="btn" data-copy="#codeA">Copier</button>
            <span class="warn">Collez ce code dans un bloc “HTML embarqué” (Wix/Webflow/Squarespace) ou avant <code>&lt;/body&gt;</code>.</span>
          </div>
        </div>

        <div id="panelB" style="display:none">
          <textarea class="code" id="codeB" readonly spellcheck="false">{{ code_script|e }}</textarea>
          <div class="actions">
            <button class="btn" data-copy="#codeB">Copier</button>
            <span class="warn">Collez ce snippet dans votre page (juste avant <code>&lt;/body&gt;</code>).</span>
          </div>
        </div>

        <div style="margin-top:14px;color:var(--muted)">
          ✔️ Les deux options affichent le <b>même</b> bot, lié à votre achat.<br>
          ✔️ L’adresse email de réception des leads est déjà associée : vous n’avez rien à modifier.<br>
          ❗ Besoin d’une autre adresse de réception ? Dites-le nous : on mettra à jour la configuration.
        </div>
      </div>

      <!-- Colonne droite : aperçu live -->
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div class="tag">Aperçu (live)</div>
        </div>
        <div class="previewBox">
          <iframe
            src="{{ embed_src }}"
            title="Aperçu — {{ full_name }}"
            loading="lazy"
            referrerpolicy="no-referrer-when-downgrade"
            allow="clipboard-read; clipboard-write; microphone; autoplay"></iframe>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Tabs
    const tabA = document.getElementById('tabA');
    const tabB = document.getElementById('tabB');
    const panelA = document.getElementById('panelA');
    const panelB = document.getElementById('panelB');

    function activate(which){
      if(which === 'A'){
        tabA.classList.add('active'); tabB.classList.remove('active');
        panelA.style.display = ''; panelB.style.display = 'none';
      }else{
        tabB.classList.add('active'); tabA.classList.remove('active');
        panelB.style.display = ''; panelA.style.display = 'none';
      }
    }
    tabA.addEventListener('click', ()=>activate('A'));
    tabB.addEventListener('click', ()=>activate('B'));

    // Copier
    document.querySelectorAll('[data-copy]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const ta = document.querySelector(btn.getAttribute('data-copy'));
        ta.select(); ta.setSelectionRange(0, 99999);
        try{ document.execCommand('copy'); }catch(e){}
        const old = btn.textContent; btn.textContent = 'Copié ✓';
        setTimeout(()=> btn.textContent = old, 1400);
      });
    });
  </script>
</body>
</html>
